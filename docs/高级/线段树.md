[toc]



åªæ±‚åŒºé—´å’Œ + æ¶‰åŠæå°‘é‡ä¿®æ”¹ï¼Œ**å‰ç¼€å’Œ**ã€‚

æ±‚åŒºé—´å’Œ + æ¶‰åŠå°‘é‡ä¿®æ”¹ï¼Œ**æ ‘çŠ¶æ•°ç»„**ã€‚

æ±‚åŒºé—´å’Œ + æ¶‰åŠå¤§é‡ä¿®æ”¹ï¼Œ**çº¿æ®µæ ‘**ã€‚



## å‰ç¼€å’Œ


### ä¸€ç»´å‰ç¼€å’Œ

```java
class NumArray {
    int[] sums;
    int[] nums;
    public NumArray(int[] nums) {
        this.nums = nums;
        sums = new int[nums.length + 1];
        for(int i = 0; i <nums.length; i++){
            sums[i+1] = sums[i] + nums[i];
        }
    }
    
    public void update(int index, int val) {
        int add = val - nums[index];
        nums[index] = val;
        for(int i = index; i < nums.length; i++){
            sums[i + 1] += add;			// numså¯¹åº”çš„sumsæ˜¯+1
        }
    }
    
    public int sumRange(int left, int right) {
        return sums[right + 1] - sums[left];
    }
}
```



#### å‰ç¼€å’Œçš„å«ä¹‰

`sums[i]` ç›´æ¥å°±æ˜¯è¡¨ç¤º `nums[0...i-1]`(**å‰ i ä¸ª**) çš„å­æ•°ç»„çš„å’Œã€‚

- $sums[0]=0$ï¼šè¡¨ç¤ºä¸€ä¸ªç©ºæ•°ç»„çš„å…ƒç´ å’Œã€‚

- $sums[i+1] = \sum\limits_{j=0}^{i}\textit{nums}[j]$ï¼šsumå®é™…ä»1å¼€å§‹

åˆ™ $sums[i+1]=sums[i]+nums[i]$



> ä¾‹å¦‚ nums=[1,2,1,2]ï¼Œå¯¹åº”çš„å‰ç¼€å’Œæ•°ç»„ä¸º sums=[0,1,3,4,6]ã€‚

#### nums[left...right]: å‰ç¼€å’Œä¹‹å·®

æŠŠå­æ•°ç»„çš„å…ƒç´ å’Œè½¬æ¢æˆä¸¤ä¸ªå‰ç¼€å’Œçš„å·®ï¼Œå³

`nums[left...right] = sums[right + 1] - sums[left]`

$$\displaystyle \sum_{j=left}^{right}\textit{nums}[j] = sums[right+1] - sums[left] = \sum\limits_{j=0}^{right} \textit{nums}[j] - \sum\limits_{j=0}^{left-1}\textit{nums}[j] $$

> é—®ï¼šä¸ºä»€ä¹ˆè¦å®šä¹‰ sums[0]=0ï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ

ç­”ï¼šå¦‚æœè¦è®¡ç®—çš„å­æ•°ç»„æ˜¯`[0...j]`ï¼Œé‚£ä¹ˆå°±æ˜¯sums[j+1]-sums[0]ã€‚å¦‚æœä¸å®šä¹‰ sums[0]=0ï¼Œå°±å¿…é¡»ç‰¹åˆ¤ left=0 çš„æƒ…å†µäº†ã€‚

![image-20240927153932012](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202409271539077.png)



### äºŒç»´å‰ç¼€å’Œ

![image-20241011230643655](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202410112306735.png)

```java
// 304. äºŒç»´åŒºåŸŸå’Œæ£€ç´¢ - çŸ©é˜µä¸å¯å˜
// 308
class NumMatrix {
    int[][] sums;
    int[][] nums;

    public NumMatrix(int[][] matrix) {
        this.nums = matrix;
        int m = matrix.length;
        int n = matrix[0].length;
        sums = new int[m + 1][n + 1];
        for (int i = 0; i < m; i++) {
            for (int j = 0; j < n; j++) {
                sums[i + 1][j + 1] = sums[i + 1][j] + sums[i][j + 1] - sums[i][j] + matrix[i][j];

            }
        }
    }

    // è¿”å›å·¦ä¸Šè§’åœ¨ (r1,c1) å³ä¸‹è§’åœ¨ (r2,c2) çš„å­çŸ©é˜µå…ƒç´ å’Œ
    public int sumRegion(int r1, int c1, int r2, int c2) {
        return sums[r2 + 1][c2 + 1] - sums[r2 + 1][c1] - sums[r1][c2 + 1] + sums[r1][c1];
    }

    // æ›´æ–°ï¼šç”°å­—å½¢ã€‚å³ä¸‹è§’çŸ©å½¢çš„é¢ç§¯=æ•´ä½“é¢ç§¯-å·¦è¾¹é¢ç§¯-ä¸Šé¢é¢ç§¯+å·¦ä¸Šé¢ç§¯
    public void update(int r, int c, int val) {
        int add = val - nums[r][c];
        nums[r][c] = val;
        for (int i = r; i < nums.length; i++) {
            for (int j = c; j < nums[0].length; j++) {
                sums[i + 1][j + 1] += add+ ;
            }
        }
    }
}
```

![alt text](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images202406122243744.png)



## æ ‘çŠ¶æ•°ç»„

[äº”åˆ†é’Ÿä¸æ»‘åŠ¨ç”»è®²è§£ | æ ‘çŠ¶æ•°ç»„_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1ce411u7qP/)



è·å–ï¼š

- ä»1å¼€å§‹ã€‚ä¸¤ä¸¤å¾€ä¸Šç»“åˆã€‚

- æ¯å±‚çš„å¶æ•°ä¸‹æ ‡ç”¨ä¸åˆ°ï¼Œèˆå»ã€‚

- å¾—åˆ°ç­‰äºåŸæ•°ç»„å¤§å°çš„æ•°ç»„ï¼Œå³æ ‘çŠ¶æ•°ç»„ã€‚

![image-20240927224243692](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202409272242743.png)

![image-20241202103636786](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202412021036830.png)

æ€§è´¨ï¼š

- æ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡ä»1å¼€å§‹

- æ ‘çŠ¶æ•°ç»„çš„ä¸‹æ ‡`i`çš„`lowbit(i)`ç­‰äºå®ƒæ‰€å¯¹åº”çš„åŒºé—´é•¿åº¦

  <img src="https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202409272242553.png" alt="image-20240927224202483" style="zoom: 50%;" />

- `tree[i]`ä¸Šé¢çš„å…ƒç´ æ˜¯`tree[i + lowbit(i)]`

  ![image-20241202110442342](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202412021104394.png)



ã€åˆå§‹åŒ–ã€‘ï¼šé updateé€ä¸ªéå†åŸæ•°ç»„



ã€ä¿®æ”¹ã€‘: ä¸Šä¸€çº§çš„ä¸‹æ ‡åˆšå¥½æ˜¯è‡ªèº«+è‡ªèº«çš„lowbit



ã€æŸ¥è¯¢ã€‘ï¼šè‡ªèº«å…ƒç´ çš„å€¼ + å‰é¢çš„ä¸Šä¸€çº§å…ƒç´ 

ã€‚é‚£ä¹ˆ idx - lowbit(idx) å°±æ˜¯å‰é¢å…ƒç´ 

ä¿®æ”¹å’ŒæŸ¥è¯¢çš„å¤æ‚åº¦éƒ½æ˜¯O(logN)

**è‡ªèº«å…ƒç´ çš„å€¼ + å‰é¢çš„ä¸Šä¸€çº§å…ƒç´ **

<img src="https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202409272241712.png" alt="image-20240927224129622" style="zoom:50%;" />

```java
class NumArray {
    int[] nums;
    TreeArray treeArray;

    public NumArray(int[] nums) {
        this.nums = nums;
        treeArray = new TreeArray(nums);
    }

    public void update(int index, int val) {
        int add = val - nums[index];
        nums[index] = val;
        treeArray.update(index + 1, add);
    }

    public int sumRange(int left, int right) {
        return treeArray.count(right + 1) - treeArray.count(left);
    }

    static class TreeArray {
        int[] tree;

        public TreeArray(int[] nums) {
            int n = nums.length;
            this.tree = new int[n + 1];
	        // åˆå§‹åŒ–ï¼šå‡è®¾numséƒ½æ˜¯0ï¼Œè‡ªç„¶treeä¹Ÿéƒ½æ˜¯0ï¼Œé‚£ä¹ˆä¸€ä¸ªä¸ªæ›´æ–°
            for (int i = 1; i <= n; i++) {
                update(i, nums[i - 1]);
            }
        }

        public void update(int i, int add) {
            while (i < tree.length) {
                tree[i] += add;
                i += i & -i;
            }
        }

        // ç¬¬1ä¸ªåˆ°ç¬¬iä¸ªï¼ˆåŒ…æ‹¬ï¼‰ çš„å’Œ
        public int count(int i) {
            int res = 0;
            while(i > 0){
                res += tree[i];
                i -= i & -i;
            }
            return res;
            
            // if (i == 0) {
            //     return 0;
            // }
            // return count(i - (i & -i)) + tree[i];
        }
    }
}
```

## çº¿æ®µæ ‘

### ä¸€ç»´

![åŒºé—´ [0, 7] å¯¹åº”çš„çº¿æ®µæ ‘](https://cdn.jsdelivr.net/gh/sword4869/pic1@main/images/202409272111078.png)

```java
// 303. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„ä¸å¯å˜
class NumArray {
    Tree tree;

    public NumArray(int[] nums) {
        tree = new Tree(nums);
    }

    public int sumRange(int left, int right) {
        return tree.queryInterval(left, right);
    }
}

class Node {
    int val;
    int left;
    int right;
    int lazy = -1;
}

class Tree {
    int[] nums;
    Node[] nodes;

    public Tree(int[] nums) {
        this.nums = nums;
        nodes = new Node[4 * nums.length];
        for (int i = 0; i < nodes.length; i++) {
            nodes[i] = new Node();
        }
        buildTree(0, 0, nums.length - 1);
    }

    // left, right æ˜¯ç´¢å¼•
    private void buildTree(int idx, int left, int right) {
        // è®¾å®šèŠ‚ç‚¹çš„å·¦å³
        nodes[idx].left = left;
        nodes[idx].right = right;

        // é€’å½’é€€å‡ºæ¡ä»¶ï¼šå¶å­èŠ‚ç‚¹
        if (left == right) {
            nodes[idx].val = nums[left];
            return;
        }

        // å·¦å³å­æ ‘é€’å½’
        int mid = left + right >>> 1;
        int left_idx = idx * 2 + 1;
        int right_idx = idx * 2 + 2;
        buildTree(left_idx, left, mid);
        buildTree(right_idx, mid + 1, right);

        // å‘ä¸Šæ›´æ–°
        pushup(idx);
    }

    private void pushup(int idx) {
        int left_idx = idx * 2 + 1;
        int right_idx = idx * 2 + 2;
        nodes[idx].val = nodes[left_idx].val + nodes[right_idx].val;
    }

    public int queryInterval(int left, int right) {
        return _queryInterval(left, right, 0, 0, nums.length - 1);
    }

    private int _queryInterval(int qLeft, int qRight, int idx, int left, int right) {
        // è¢«æŸ¥è¯¢åŒºé—´åŒ…è£¹
        if (qLeft <= left && right <= qRight) {
            return nodes[idx].val;
        }

        // è¶…å‡º
        if (qRight < left || right < qLeft) {
            return 0;
        }

        // å‘ä¸‹æ›´æ–°
        // pushdown(idx);

        // å·¦å³å­æ ‘ä¸­æŸ¥è¯¢
        int mid = left + right >>> 1;
        int left_idx = idx * 2 + 1;
        int right_idx = idx * 2 + 2;
        int sum = 0;
        if (left <= mid) {
            sum += _queryInterval(qLeft, qRight, left_idx, left, mid);
        }
        if (right > mid) {
            sum += _queryInterval(qLeft, qRight, right_idx, mid + 1, right);
        }
        return sum;
    }
}
```

## leetcode

ä¸€ç»´ï¼š

[303. åŒºåŸŸå’Œæ£€ç´¢.md](..\..\é¢˜\leetcode\303. åŒºåŸŸå’Œæ£€ç´¢.md) ï¼šæ•°ç»„ä¸ä¿®æ”¹

ğŸš€[307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹.md](..\..\é¢˜\leetcode\307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹.md) ï¼šè¶…æ—¶ï¼Œè¦ç”¨çº¿æ®µæ ‘

[å°ç±³25æ¨¡æ‹Ÿæ‹¿ç³–æœ.md](..\..\é¢˜\ç¬”è¯•\çœŸé¢˜\å°ç±³25æ¨¡æ‹Ÿæ‹¿ç³–æœ.md) 



äºŒç»´ï¼š

[304. äºŒç»´åŒºåŸŸå’Œæ£€ç´¢.md](..\..\é¢˜\leetcode\304. äºŒç»´åŒºåŸŸå’Œæ£€ç´¢.md) 





[2602. ä½¿æ•°ç»„å…ƒç´ å…¨éƒ¨ç›¸ç­‰çš„æœ€å°‘æ“ä½œæ¬¡æ•°](../../leetcode/2602.%20ä½¿æ•°ç»„å…ƒç´ å…¨éƒ¨ç›¸ç­‰çš„æœ€å°‘æ“ä½œæ¬¡æ•°.md)

[560. å’Œä¸º K çš„å­æ•°ç»„](../../leetcode/560.%20å’Œä¸ºKçš„å­æ•°ç»„.md)





todoï¼š[å‰ç¼€å’ŒåŠå…¶æ‰©å±•ï¼Œé™„é¢˜å•ï¼](https://leetcode.cn/problems/range-sum-query-immutable/solutions/2693498/qian-zhui-he-ji-qi-kuo-zhan-fu-ti-dan-py-vaar/)
